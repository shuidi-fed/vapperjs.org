<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Writing a plugin | Vapper</title>
    <meta name="description" content="A Vue-based server-side rendering framework">
    
    
    <link rel="preload" href="/assets/css/0.styles.02f63e62.css" as="style"><link rel="preload" href="/assets/js/app.75098c1e.js" as="script"><link rel="preload" href="/assets/js/2.d400e92f.js" as="script"><link rel="preload" href="/assets/js/28.34c13167.js" as="script"><link rel="preload" href="/assets/js/5.a70af778.js" as="script"><link rel="prefetch" href="/assets/js/10.a238c216.js"><link rel="prefetch" href="/assets/js/11.93200388.js"><link rel="prefetch" href="/assets/js/12.8321d79b.js"><link rel="prefetch" href="/assets/js/13.f00c4fe6.js"><link rel="prefetch" href="/assets/js/14.803d8fbc.js"><link rel="prefetch" href="/assets/js/15.ab49d01f.js"><link rel="prefetch" href="/assets/js/16.e1f3442e.js"><link rel="prefetch" href="/assets/js/17.e3665905.js"><link rel="prefetch" href="/assets/js/18.6eba3bc8.js"><link rel="prefetch" href="/assets/js/19.fc099a71.js"><link rel="prefetch" href="/assets/js/20.cdd8ac45.js"><link rel="prefetch" href="/assets/js/21.eca1f057.js"><link rel="prefetch" href="/assets/js/22.cfcb0507.js"><link rel="prefetch" href="/assets/js/23.a66ea920.js"><link rel="prefetch" href="/assets/js/24.5f598cac.js"><link rel="prefetch" href="/assets/js/25.233c5492.js"><link rel="prefetch" href="/assets/js/26.c946b027.js"><link rel="prefetch" href="/assets/js/27.fe6c3a55.js"><link rel="prefetch" href="/assets/js/29.c10b2bc3.js"><link rel="prefetch" href="/assets/js/3.ff3a75ea.js"><link rel="prefetch" href="/assets/js/30.8c7224f9.js"><link rel="prefetch" href="/assets/js/31.ce6d4e00.js"><link rel="prefetch" href="/assets/js/32.9afcbc22.js"><link rel="prefetch" href="/assets/js/33.7814c979.js"><link rel="prefetch" href="/assets/js/34.45c5f16b.js"><link rel="prefetch" href="/assets/js/35.f4e15fa6.js"><link rel="prefetch" href="/assets/js/36.feb10634.js"><link rel="prefetch" href="/assets/js/37.c2606191.js"><link rel="prefetch" href="/assets/js/38.e92c7e9d.js"><link rel="prefetch" href="/assets/js/39.147b66fc.js"><link rel="prefetch" href="/assets/js/4.6f1a593f.js"><link rel="prefetch" href="/assets/js/40.c35ff5fe.js"><link rel="prefetch" href="/assets/js/41.f62b8795.js"><link rel="prefetch" href="/assets/js/42.9c5935ab.js"><link rel="prefetch" href="/assets/js/43.aa4b86ba.js"><link rel="prefetch" href="/assets/js/44.8be6f2ee.js"><link rel="prefetch" href="/assets/js/45.50d7724e.js"><link rel="prefetch" href="/assets/js/46.7474df56.js"><link rel="prefetch" href="/assets/js/47.a0463bd9.js"><link rel="prefetch" href="/assets/js/48.dc12d8a2.js"><link rel="prefetch" href="/assets/js/49.0ddc00d8.js"><link rel="prefetch" href="/assets/js/6.d1383401.js"><link rel="prefetch" href="/assets/js/7.fd7915df.js"><link rel="prefetch" href="/assets/js/8.40b285d8.js"><link rel="prefetch" href="/assets/js/9.1e07b9c3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.02f63e62.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Vapper</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/introduction.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="/write-plugin.html" class="nav-link router-link-exact-active router-link-active">Advanced</a></div><div class="nav-item"><a href="/config.html" class="nav-link">Configuration</a></div><div class="nav-item"><a href="/troubleshooting.html" class="nav-link">Troubleshooting</a></div><div class="nav-item"><a href="/migrating.html" class="nav-link">Migrating from v0.x</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/write-plugin.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/zh/write-plugin.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/vapperjs/vapper" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/introduction.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="/write-plugin.html" class="nav-link router-link-exact-active router-link-active">Advanced</a></div><div class="nav-item"><a href="/config.html" class="nav-link">Configuration</a></div><div class="nav-item"><a href="/troubleshooting.html" class="nav-link">Troubleshooting</a></div><div class="nav-item"><a href="/migrating.html" class="nav-link">Migrating from v0.x</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/write-plugin.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/zh/write-plugin.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/vapperjs/vapper" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Advanced</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/write-plugin.html" class="active sidebar-link">Writing a plugin</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/write-plugin.html#basic" class="sidebar-link">Basic</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#debugging-a-plugin" class="sidebar-link">Debugging a plugin</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#register-server-middlewares" class="sidebar-link">Register server middlewares</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#register-command" class="sidebar-link">Register command</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#enhance-runtime-capabilities" class="sidebar-link">Enhance runtime capabilities</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/write-plugin.html#compile-the-enhancement-files" class="sidebar-link">Compile the enhancement files</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#optional-compilation" class="sidebar-link">Optional compilation</a></li></ul></li><li class="sidebar-sub-header"><a href="/write-plugin.html#pass-options-for-the-plugin" class="sidebar-link">Pass options for the plugin</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#plugin-api" class="sidebar-link">Plugin API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/write-plugin.html#api-resolvecwd" class="sidebar-link">api.resolveCWD()</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#api-resolveout" class="sidebar-link">api.resolveOut()</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#api-chainwebpack" class="sidebar-link">api.chainWebpack()</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#api-use" class="sidebar-link">api.use()</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#api-getroutemeta" class="sidebar-link">api.getRouteMeta()</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#api-hookinto" class="sidebar-link">api.hookInto()</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#api-addenhancefile" class="sidebar-link">api.addEnhanceFile()</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#api-isprod" class="sidebar-link">api.isProd</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#api-options" class="sidebar-link">api.options</a></li><li class="sidebar-sub-header"><a href="/write-plugin.html#api-logger" class="sidebar-link">api.logger</a></li></ul></li></ul></li><li><a href="/custom-server.html" class="sidebar-link">Custom Server</a></li><li><a href="/configer.html" class="sidebar-link">Configer</a></li><li><a href="/state-injection.html" class="sidebar-link">State Injection</a></li></ul></section></li><li><a href="/config.html" class="sidebar-link">Configuration</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="writing-a-plugin"><a href="#writing-a-plugin" aria-hidden="true" class="header-anchor">#</a> Writing a plugin</h1> <h2 id="basic"><a href="#basic" aria-hidden="true" class="header-anchor">#</a> Basic</h2> <p>A plugin is a function:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// myVapperPlugin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This function takes a <code>PluginApi</code> instance as a parameter, which provides a number of methods that let you intervene in the core of <code>Vapper</code> and also provides a number of utility functions.</p> <h2 id="debugging-a-plugin"><a href="#debugging-a-plugin" aria-hidden="true" class="header-anchor">#</a> Debugging a plugin</h2> <p>In the <a href="/using-plugin.html#using-plugin">Using Plugins</a> section we learned that a plugin can be a function:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vapper.config.js</span>
<span class="token keyword">const</span> myVapperPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./myVapperPlugin.js'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>myVapperPlugin<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>So you can simply import the local plugin and debug it.</p> <h2 id="register-server-middlewares"><a href="#register-server-middlewares" aria-hidden="true" class="header-anchor">#</a> Register server middlewares</h2> <p>Use the <code>api.use()</code> function to register a server middleware:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// myVapperPlugin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'before:render'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Before rendering'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  api<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'after:render'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Do something'</span><span class="token punctuation">)</span>
      <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'After rendering'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Middleware is written in accordance with the conventions of <a href="https://github.com/senchalabs/connect" target="_blank" rel="noopener noreferrer">connect<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>The server-side rendering of <code>Vapper</code> is essentially a server middleware, we temporarily call it &quot;rendering middleware&quot;, therefore, when using the A function to register the middleware, you can either register the middleware that was executed before the &quot;rendering middleware&quot; or register the middleware that is executed after the &quot;rendering middleware&quot;:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// myVapperPlugin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Before rendering middleware</span>
  api<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'before:render'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// After rendering middleware</span>
  api<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'after:render'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In fact, when registering middleware that is executed before &quot;rendering middleware&quot;, you can omit <code>'before:render'</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// myVapperPlugin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Before rendering middleware</span>
  api<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// After rendering middleware</span>
  api<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'after:render'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In most cases, you may need to customize the server. For custom server you can read: <a href="/custom-server.html#connect">Custom Server</a>. When customizing the server, you don't need to register the middleware as a plugin, because you can use the middleware directly in your custom <code>Server</code>.</p> <p>In addition to registering <code>before:render</code> and <code>after:render</code> middleware, you can also register <code>before:setup</code> and <code>after:setup</code> middleware. The difference is that they are executed in a different order, as follows:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Execute from top to bottom</span>
before<span class="token punctuation">:</span>setup
before<span class="token punctuation">:</span>render
after<span class="token punctuation">:</span>render
after<span class="token punctuation">:</span>setup
</code></pre></div><div class="tip custom-block"><p>Middleware types <code>before:setup</code> and <code>after:setup</code> are only available in <code>@vapper/core@1.3.0+</code> versions.</p></div> <h2 id="register-command"><a href="#register-command" aria-hidden="true" class="header-anchor">#</a> Register command</h2> <p>A new <code>CLI</code> command can be registered via the plugin, and the <code>module.exports.CLI</code> function needs to be exported in the plugin module:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// myVapperPlugin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function-variable function">$someFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Do something'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">CLI</span> <span class="token operator">=</span> <span class="token punctuation">(</span>Vapper<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Vapper<span class="token punctuation">.</span>cli
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'custom'</span><span class="token punctuation">,</span> <span class="token string">'Custom command'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">allowUnknownOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">async</span> flags <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> vapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vapper</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span><span class="token punctuation">(</span>flags <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">:</span> <span class="token string">'production'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      vapper<span class="token punctuation">.</span><span class="token function">$someFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>module.exports.CLI</code> function accepts the <code>Vapper</code> class as a parameter, <code>Vapper.cli</code> is a command-line program instance, and <code>Vapper</code> uses <a href="https://github.com/cacjs/cac" target="_blank" rel="noopener noreferrer">CAC<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as a command-line parsing tool, so the way to register a new command can be viewed <a href="https://github.com/cacjs/cac" target="_blank" rel="noopener noreferrer">CAC<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> documentation.</p> <p>After registering a new command, we can run the command via <code>vapper [command]</code>. In addition, we can add a function to <code>api</code>, such as <code>api.$someFn</code> in the above code, which can be called in the <code>action</code> of the command line via the <code>Vapper</code> instance.</p> <p>You can check the <a href="https://github.com/vapperjs/vapper/blob/master/packages/vapper-plugin-prerender/lib/index.js" target="_blank" rel="noopener noreferrer">@vapper/plugin-prerender<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> code as a reference case.</p> <h2 id="enhance-runtime-capabilities"><a href="#enhance-runtime-capabilities" aria-hidden="true" class="header-anchor">#</a> Enhance runtime capabilities</h2> <p>In the previous introduction, the plugin's capabilities were limited to non-runtime levels and could not extend the application's runtime capabilities, but in fact it was important to extend the application's runtime capabilities. For example, the <a href="/zh/using-plugin.html#vapper-plugin-cookie">@vapper/plugin-cookie</a> plugin extends the runtime capabilities of the <code>Vapper</code> application, allowing us to manipulate <code>cookie</code> isomorphicly.</p> <p>riting a runtime plugin is basically the same as writing a normal plugin, and also exporting a function:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// myVapperPlugin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>But we need to dynamically add runtime code using the <code>api.addEnhanceFile</code> function:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// myVapperPlugin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">addEnhanceFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// The code for this file is only run on the client</span>
    client<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./client.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// The code for this file is only run on the server</span>
    server<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./server.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then we can write the <code>client.js</code> and <code>server.js</code> files separately:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// client.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ......</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ......</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Both <code>server.js</code> and <code>client.js</code> need to have a default exported function, and the function accepts <a href="/entry.html#context">ctx</a> as a parameter, as shown below for the contents of <a href="/entry.html#context">ctx</a>:</p> <ul><li>On the client:</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>context <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token comment">// 'server' or 'client'</span>
  pluginRuntimeOptions<span class="token punctuation">:</span> createApp<span class="token punctuation">.</span>pluginRuntimeOptions<span class="token punctuation">,</span>  <span class="token comment">// createApp.pluginRuntimeOptions</span>
  rootOptions <span class="token comment">// The root component options</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>On the server:</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>context <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token comment">// 'server' or 'client'</span>
  pluginRuntimeOptions<span class="token punctuation">:</span> createApp<span class="token punctuation">.</span>pluginRuntimeOptions<span class="token punctuation">,</span>  <span class="token comment">// createApp.pluginRuntimeOptions</span>
  req<span class="token punctuation">:</span> context<span class="token punctuation">.</span>req<span class="token punctuation">,</span> <span class="token comment">// Request object, available only in `server.js`</span>
  res<span class="token punctuation">:</span> context<span class="token punctuation">.</span>res<span class="token punctuation">,</span> <span class="token comment">// Response object, available only in `server.js`</span>
  isFake<span class="token punctuation">,</span>  <span class="token comment">// A Boolean value that indicates whether the rendering is actually performed. It will be explained in detail later and is only available in `server.js`.</span>
  url<span class="token punctuation">:</span> req<span class="token punctuation">.</span>url<span class="token punctuation">,</span>  <span class="token comment">// the request url</span>
  rootOptions <span class="token comment">// the root component options</span>
<span class="token punctuation">}</span>
</code></pre></div><p>With these capabilities in place, we can try to write plugins to enhance the runtime. Next, let's write a plugin that injects <code>$logger</code> function for <a href="/entry.html#context">context</a> as an example of how to write plugins to enhance the runtime.</p> <p>The main purpose of the runtime plugin is: enhance the <a href="/entry.html#context">context</a> object, as shown in the following code, we add the <code>$logger</code> attribute on the <a href="/entry.html#context">context</a> object:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// client.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>$logger <span class="token operator">=</span> console<span class="token punctuation">.</span>log
<span class="token punctuation">}</span>
</code></pre></div><p>The same code can be used in <code>server.js</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>$logger <span class="token operator">=</span> console<span class="token punctuation">.</span>log
<span class="token punctuation">}</span>
</code></pre></div><p>You have noticed that the same code we wrote twice in <code>client.js</code> and <code>server.js</code>, in fact, <code>client.js</code> and <code>server.js</code> can be the same file:</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token comment">// myVapperPlugin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">addEnhanceFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    client<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./logger.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    server<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./logger.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As shown in the code above, we point <code>client</code> and <code>server</code> to the same <code>logger.js</code> file, so we only need to write the code once:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// logger.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>$logger <span class="token operator">=</span> console<span class="token punctuation">.</span>log
<span class="token punctuation">}</span>
</code></pre></div><p>But some code can only be run on the server or client. At this time we need to use <code>type</code> to distinguish the current running environment:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// logger.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isServer <span class="token operator">=</span> ctx<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'server'</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>$logger <span class="token operator">=</span> customLogger
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>$logger <span class="token operator">=</span> console<span class="token punctuation">.</span>log
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Since one file can satisfy the requirements, why design two files <code>client.js</code> and <code>server.js</code>? In fact, using only one file can indeed meet the requirements, but this will cause the client to include the server's code. Similarly, the client's code will also exist in the server. Although this does not affect the normal execution of the code, it increases the size of the bundle, so if the code between the client and the server is quite different, it is recommended to write two files separately.</p> <p>The runtime plugin enhances the <a href="/entry.html#context">context</a> object by adding new attributes to <a href="/entry.html#context">context</a>, so we can use it in the entry file:</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token comment">// Entry file</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createApp</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>$logger <span class="token comment">// Access `$logger` via `ctx`.</span>
  
  <span class="token comment">// Omit ...</span>

  <span class="token keyword">return</span> app
<span class="token punctuation">}</span>
</code></pre></div><h3 id="compile-the-enhancement-files"><a href="#compile-the-enhancement-files" aria-hidden="true" class="header-anchor">#</a> Compile the enhancement files <span class="badge tip" style="vertical-align:top;" data-v-c13ee5b0>1.3.0+</span></h3> <p>By default, the runtime file is compiled. <code>Vapper</code> uses <code>lodash.template</code> to compile it internally. Taking <code>logger.js</code> mentioned above as an example, we can use interpolation in this file:</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token comment">// logger.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token operator">%=</span> foo <span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Passing compilation options:</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">addEnhanceFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    client<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./logger.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    clientOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'foo-client'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    server<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./logger.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    serverOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'foo-server'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Vapper</code> will compile the <code>logger.js</code> file and generate <code>.vapper_server.js</code> and<code>.vapper-client.js</code> files respectively:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// .vapper_server.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo-server'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// .vapper_client.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo-client'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="optional-compilation"><a href="#optional-compilation" aria-hidden="true" class="header-anchor">#</a> Optional compilation</h3> <p>As mentioned above, the &quot;enhancement-files&quot; are compiled by default. If your <code>enhancement-files</code> do not need to be compiled, you can turn it off:</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">addEnhanceFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    needCompile<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    client<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./logger.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    clientOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'foo-client'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    server<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./logger.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    serverOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'foo-server'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="pass-options-for-the-plugin"><a href="#pass-options-for-the-plugin" aria-hidden="true" class="header-anchor">#</a> Pass options for the plugin</h2> <p>As mentioned above, plugins can enhance runtime capabilities, as well as register new <code>CLI</code> commands and server middleware. Different types of plugins receive option parameters differently. For plugins that enhance runtime capabilities, we need to use the <code>createApp.pluginRuntimeOptions</code> object exported by the entry file, for example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Entry file</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createApp</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

createApp<span class="token punctuation">.</span>pluginRuntimeOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>So in the plugin's runtime file, we can get the options like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js 或 client.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> pluginRuntimeOptions <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pluginRuntimeOptions<span class="token punctuation">.</span>logger<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For plugins that don't enhance runtime capabilities, we only need to pass options for the plugin in <code>vapper.config.js</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> myVapperPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./myVapperPlugin'</span><span class="token punctuation">)</span>
<span class="token comment">// vapper.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>myVapperPlugin<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">/* plugin options */</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p>Some plugins may receive both the options passed in <code>vapper.config.js</code> and the runtime options in <code>pluginRuntimeOptions</code>.</p></div> <h2 id="plugin-api"><a href="#plugin-api" aria-hidden="true" class="header-anchor">#</a> Plugin API</h2> <h3 id="api-resolvecwd"><a href="#api-resolvecwd" aria-hidden="true" class="header-anchor">#</a> api.resolveCWD()</h3> <p>Resolve the path based on the current working directory.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// pwd: /Users/work</span>
api<span class="token punctuation">.</span><span class="token function">resolveCWD</span><span class="token punctuation">(</span><span class="token string">'./foo.js'</span><span class="token punctuation">)</span>  <span class="token comment">// /Users/work/foo.js</span>
</code></pre></div><h3 id="api-resolveout"><a href="#api-resolveout" aria-hidden="true" class="header-anchor">#</a> api.resolveOut()</h3> <p>Resolve the path based on the <code>output.path</code> of webpack</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Wbepack output.path: /Users/work/my-project/dist</span>
api<span class="token punctuation">.</span><span class="token function">resolveOut</span><span class="token punctuation">(</span><span class="token string">'./foo.js'</span><span class="token punctuation">)</span>  <span class="token comment">// /Users/work/my-project/dist/foo.js</span>
</code></pre></div><h3 id="api-chainwebpack"><a href="#api-chainwebpack" aria-hidden="true" class="header-anchor">#</a> api.chainWebpack() <span class="badge tip" style="vertical-align:top;" data-v-c13ee5b0>1.3.0+</span></h3> <p>Register a function to modify the <code>webpack</code> configuration. This function receives a <code>ChainableConfig</code> instance(<a href="https://github.com/neutrinojs/webpack-chain" target="_blank" rel="noopener noreferrer">webpack-chain<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) as a parameter:</p> <div class="language-js extra-class"><pre class="language-js"><code>api<span class="token punctuation">.</span><span class="token function">chainWebpack</span><span class="token punctuation">(</span>config <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="api-use"><a href="#api-use" aria-hidden="true" class="header-anchor">#</a> api.use()</h3> <p>Register a <code>Server</code> middleware:</p> <ul><li>Register the middleware that was executed before &quot;Rendering Middleware&quot;:</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>api<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>Register the middleware that was executed after &quot;Rendering Middleware&quot;:</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>api<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'after:render'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="api-getroutemeta"><a href="#api-getroutemeta" aria-hidden="true" class="header-anchor">#</a> api.getRouteMeta()</h3> <p>Get the route metadata corresponding to the current request. Usually used in the middleware of a custom server to read route metadata, for example:</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token comment">// custom server: server.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Vapper <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vapper/core'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">starter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> vapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vapper</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'production'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      port<span class="token punctuation">,</span>
      host
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> vapper

  <span class="token keyword">await</span> vapper<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> meta <span class="token operator">=</span> vapper<span class="token punctuation">.</span><span class="token function">getRouteMeta</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token comment">// Do something</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> vapper<span class="token punctuation">.</span>handler<span class="token punctuation">)</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> vapper<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Server running at: http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">starter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="api-hookinto"><a href="#api-hookinto" aria-hidden="true" class="header-anchor">#</a> api.hookInto()</h3> <p>Register the hook function:</p> <div class="language-js extra-class"><pre class="language-js"><code>api<span class="token punctuation">.</span><span class="token function">hookInto</span><span class="token punctuation">(</span><span class="token string">'before:setup'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Before Setup'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>The available hooks are:</p> <ul><li><code>before:setup</code></li> <li><code>after:setup</code></li> <li><code>before:render</code></li> <li><code>after:render</code></li></ul> <p>The <code>after:render</code> hook function will receive the rendered <code>html</code> string as a parameter:</p> <div class="language-js extra-class"><pre class="language-js"><code>api<span class="token punctuation">.</span><span class="token function">hookInto</span><span class="token punctuation">(</span><span class="token string">'after:render'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>htmlContent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>htmlContent<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="api-addenhancefile"><a href="#api-addenhancefile" aria-hidden="true" class="header-anchor">#</a> api.addEnhanceFile()</h3> <p>Used to register runtime files:</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">addEnhanceFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// The code for this file is only run on the client</span>
    client<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./client.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// The code for this file is only run on the server</span>
    server<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./server.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You can check <a href="/write-plugin.html#enhance-runtime-capabilities">Enhance runtime capabilities</a> for detailed usage.</p> <h3 id="api-isprod"><a href="#api-isprod" aria-hidden="true" class="header-anchor">#</a> api.isProd</h3> <p>A <code>boolean</code> value that represents whether the environment is a production environment.</p> <h3 id="api-options"><a href="#api-options" aria-hidden="true" class="header-anchor">#</a> api.options</h3> <p>Mix the command line arguments with the configuration data in <code>vapper.config.js</code> to produce the final options. All available options: <a href="/config.html">Configuration</a></p> <h3 id="api-logger"><a href="#api-logger" aria-hidden="true" class="header-anchor">#</a> api.logger</h3> <p>Log tool:</p> <div class="language-js extra-class"><pre class="language-js"><code>api<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
api<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
api<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
api<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
api<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">tip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
api<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>The log print behavior can be controlled through the configuration file: <a href="/config.html#loglevel">Config - logLevel</a>.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/vapperjs/vapper/edit/master/docs/write-plugin.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/typescript.html" class="prev">
          Use TypeScript
        </a></span> <span class="next"><a href="/custom-server.html">
          Custom Server
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/2.d400e92f.js" defer></script><script src="/assets/js/28.34c13167.js" defer></script><script src="/assets/js/5.a70af778.js" defer></script><script src="/assets/js/app.75098c1e.js" defer></script>
  </body>
</html>
